<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head id="Head1">
    <meta http-equiv="Content-Type" content="text/html; charset=gbk">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>报告防伪查询</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://cdn.bootcss.com/twitter-bootstrap/3.0.3/css/bootstrap.min.css">
    <script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script src="http://www.fcl-sz.org.cn/weixin/JQueryUI/plugin/jquery.query-2.1.7.js"></script>
    <link href="http://www.fcl-sz.org.cn/weixin/Styles/scrollUp.css" rel="stylesheet">
    <script src="http://www.fcl-sz.org.cn/weixin/Scripts/scrollUp.js"></script>
    <link href="http://www.fcl-sz.org.cn/weixin/Styles/loading.css" rel="stylesheet">
    <script src="http://www.fcl-sz.org.cn/weixin/Scripts/userAgent.js"></script>

    <script type="text/javascript">
        $(function () {
            var params_report_codes = window.location.search.match(new RegExp("[\?\&]va_no=([^\&]+)", "i"));
            $.ajax({
                type: "post",
                url: "QueryReport.aspx",
                dataType: "json",
                data: { action: "getdata", report_no: $.query.get("re_no"), report_code: params_report_codes[1] },
                beforeSend: function (XMLHttpRequest) {
                    $("#loading").show();
                },
                success: function (data, textStatus) {
                    var html = '';
                    if (data.status == "ok") {
                        // 替换下载链接为查看详情功能
                        html += '点击查看详细报告 <a href="javascript:viewReport(\'' + data.md5 + '\',\'' + data.report_no + '\')">' + data.report_no + '</a>';
                    } else {
                        html = '<span class="error">' + data.status + '</span>';
                    }
                    $("#div_search_result").html(html);
                },
                complete: function (XMLHttpRequest, textStatus) {
                    $("#loading").hide();
                },
                error: function () {
                    $("#div_search_result").html("出错啦~");
                }
            });
        });

        var reportArray = new Array();

        function contains(array, str) {
            for (var i = 0; i < array.length; i++) {
                if (str == array[i]) {
                    return true;
                }
            }
            return false;
        }

        function viewReport(md5, reportNo) {
            var flag = false;
            $("#accordion").show();
            if (!contains(reportArray, reportNo)) {
                flag = true;
                $.ajax({
                    type: "post",
                    url: "Report.Pdf2Image.ashx",
                    dataType: "json",
                    data: { md5: md5 },
                    beforeSend: function (XMLHttpRequest) {
                        $("#loading").show();
                    },
                    success: function (data, textStatus) {
                        reportArray.push(reportNo);
                        var html = '';
                        html += '<div id="' + reportNo + '" class="panel panel-default">';
                        html += '   <div class="panel-heading">';
                        html += '       <h4 class="panel-title">';
                        html += '           <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#collapse' + reportArray.length + '">';
                        html += '               <span id="glyphicon_' + reportNo + '" class="glyphicon glyphicon-chevron-down"></span>';
                        html += '               报告号：' + reportNo;
                        html += '           </a>';
                        html += '       </h4>';
                        html += '   </div>';
                        var classStr = "panel-collapse collapse";
                        html += '   <div id="collapse' + reportArray.length + '" class="' + classStr + '">';
                        html += '       <div class="panel-body">';
                        for (var i = 0; i < data.length; i++) {
                            html += '       <img class="img-report" src="download\\' + data[i] + '" />';
                        }
                        html += '       </div>';
                        html += '   </div>';
                        html += '</div>';
                        $("#accordion").append(html);

                        $('#' + reportNo).on('shown.bs.collapse', function () {
                            $("#glyphicon_" + reportNo).attr("class", "glyphicon glyphicon-chevron-up");
                        });
                        $('#' + reportNo).on('hidden.bs.collapse', function () {
                            $("#glyphicon_" + reportNo).attr("class", "glyphicon glyphicon-chevron-down");
                        });
                    },
                    complete: function (XMLHttpRequest, textStatus) {
                        $("#loading").hide();
                        d_collapse(reportNo);
                    },
                    error: function () {
                        alert("出错啦~");
                    }
                });
            }
            if (!flag) {
                d_collapse(reportNo);
            }
        }

        function d_collapse(reportNo) {
            var index = 0;
            for (var i = 0; i < reportArray.length; i++) {
                if (reportArray[i] == reportNo) {
                    index = i + 1;
                }
            }
            $('#collapse' + index.toString()).collapse('toggle');

            for (var i = 0; i < reportArray.length; i++) {
                if (i + 1 == index) {
                    $('#collapse' + (i + 1).toString()).collapse('show');
                } else {
                    $('#collapse' + (i + 1).toString()).collapse('hide');
                }
            }
        }
    </script>

    <style type="text/css">
        body {
            font-size: 16px;
        }
        .error {
            color: red;
        }
        .img-report {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            background-color: #f5f5f5;
            margin-bottom: 2px;
        }
        .panel-body {
            padding: 3px;
        }
    </style>
</head>

<body>
    <form method="post" action="#" id="form1">
        <div class="container" style="margin-top: 5px;">
            <div id="loading" style="display: none;">加载中...</div>
            <div id="div_search_result">点击查看详细报告</div>
            <div class="panel-group" id="accordion" style="display: none;"></div>
            <a id="scrollUp" href="#top"></a>
            <br>
            <br>
        </div>
    </form>
</body>
</html>
